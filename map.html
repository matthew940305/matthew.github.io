<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>地圖地標管理</title>
<style>
  :root {
    color-scheme: light;
  }

  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: Arial, "Noto Sans TC", sans-serif;
    background-color: #f4f6f9;
  }

  #map {
    width: 100%;
    height: 70vh;
  }

  .controls {
    box-sizing: border-box;
    padding: 16px;
    background-color: #fff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .controls h2 {
    margin: 0 0 12px;
    font-size: 18px;
  }

  .form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 12px;
  }

  .form-row label {
    display: flex;
    flex-direction: column;
    font-size: 14px;
  }

  .form-row input {
    width: 220px;
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
  }

  .controls button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    background-color: #1976d2;
    color: #fff;
    cursor: pointer;
  }

  .controls button:hover {
    background-color: #125a9c;
  }

  .note {
    font-size: 13px;
    color: #666;
  }

  .marker-label {
    position: absolute;
    padding: 0 2px;
    font-size: 13px;
    font-weight: 700;
    color: #d93025;
    white-space: nowrap;
    pointer-events: none;
    transform: translateY(-50%);
    z-index: 10;
  }

  .marker-list {
    margin-top: 20px;
    border-top: 1px solid #e0e0e0;
    padding-top: 12px;
  }

  .marker-list h3 {
    margin: 0 0 8px;
    font-size: 16px;
  }

  .marker-list__items {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .marker-list__item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 8px 10px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    background-color: #fafafa;
    transition: background-color 0.15s ease, border-color 0.15s ease, opacity 0.15s ease;
  }

  .marker-list__meta {
    display: flex;
    flex-direction: column;
    gap: 2px;
    font-size: 13px;
  }

  .marker-list__meta strong {
    font-weight: 600;
  }

  .marker-list__coords {
    color: #666;
  }

  .marker-list__delete {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    background-color: #d93025;
    color: #fff;
    cursor: pointer;
    font-size: 13px;
  }

  .marker-list__delete:hover {
    background-color: #b5231a;
  }

  .marker-list__empty {
    font-size: 13px;
    color: #777;
  }

  .marker-list__item--dragging {
    opacity: 0.4;
  }

  .marker-list__item--dragover {
    border-color: #1976d2;
    background-color: #e8f0fe;
  }
</style>
</head>
<body>
<div id="map"></div>
<section class="controls">
  <h2>輸入經緯度新增地標</h2>
  <div class="form-row">
    <label>
      地標名稱
      <input id="marker-title" type="text" placeholder="例如：校門口">
    </label>
    <label>
      緯度 (Latitude)
      <input id="marker-lat" type="number" step="any" placeholder="24.123947">
    </label>
    <label>
      經度 (Longitude)
      <input id="marker-lng" type="number" step="any" placeholder="120.674810">
    </label>
  </div>
  <button id="add-marker" type="button">加入地標</button>
  <p class="note">提示：點選地圖會自動填入該點的經緯度。拖曳下方清單即可重新排序地標。</p>
  <div class="marker-list">
    <h3>已儲存地標</h3>
    <ul id="marker-list" class="marker-list__items"></ul>
  </div>
</section>
<script>
let map;
const markers = [];
const markerData = [];
const iconCache = new Map();
let MarkerLabelClass = null;
const STORAGE_KEY = 'nchuCustomMarkers';
const DEFAULT_MARKERS = [
  {
    id: 'marker-1762338667425-3hw5ky',
    title: '狂野森林西班牙冰沙',
    lat: 24.125134374143922,
    lng: 120.67671988067356,
  },
  {
    id: 'marker-1762338710364-9u5gai',
    title: '如常。所在',
    lat: 24.12795,
    lng: 120.667057,
  },
  {
    id: 'marker-1762338742659-mp5eya',
    title: '狸匠深夜拉麵',
    lat: 24.12454686924043,
    lng: 120.68107578758496,
  },
  {
    id: 'marker-1762338779264-bb6ax5',
    title: '小川家',
    lat: 24.130070980368014,
    lng: 120.68390958361233,
  },
  {
    id: 'marker-1762338826720-o9jnwi',
    title: '榮華街咖啡',
    lat: 24.13101094626752,
    lng: 120.6796395072879,
  },
  {
    id: 'marker-1762338867422-belspx',
    title: '臺中肉員',
    lat: 24.13482948669639,
    lng: 120.68266503872387,
  },
  {
    id: 'marker-1762338890290-tcpdun',
    title: '虎野脆皮雞蛋糕',
    lat: 24.118692928541826,
    lng: 120.66640012402004,
  },
  {
    id: 'marker-1762339033499-boush1',
    title: '沼澤咖哩',
    lat: 24.127868022281522,
    lng: 120.68341724730766,
  },
  {
    id: 'marker-1762338915558-fuz476',
    title: '牧禾堂 台中忠孝總店',
    lat: 24.13027671258565,
    lng: 120.68326704355799,
  },
  {
    id: 'marker-1762339012205-dd296k',
    title: '老陳海南雞飯 復興總店',
    lat: 24.13227412862538,
    lng: 120.67781679487511,
  },
];
const dragState = {
  sourceId: null,
  hoverId: null,
};

function generateMarkerId() {
  return `marker-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
}

function escapeHtml(text) {
  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function saveMarkers() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(markerData));
  } catch (error) {
    console.warn('儲存地標時發生錯誤：', error);
  }
}

function getMarkerIcon(index) {
  const number = index + 1;
  if (number < 1 || number > 10) {
    return null;
  }

  const cacheKey = `icon-${number}`;
  if (iconCache.has(cacheKey)) {
    return iconCache.get(cacheKey);
  }

  const icon = createMarkerIcon(number);
  iconCache.set(cacheKey, icon);
  return icon;
}

function createMarkerIcon(number) {
  const labelText = number <= 99 ? number : '99+';
  const svg = `
    <svg width="44" height="48" viewBox="0 0 44 48" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="pinGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#f2503f"/>
          <stop offset="100%" stop-color="#c41f18"/>
        </linearGradient>
        <filter id="pinShadow" x="-20%" y="-20%" width="140%" height="160%">
          <feOffset dx="0" dy="2" in="SourceAlpha" result="offset"/>
          <feGaussianBlur in="offset" stdDeviation="2" result="blur"/>
          <feBlend in="SourceGraphic" in2="blur" mode="normal"/>
        </filter>
      </defs>
      <g filter="url(#pinShadow)">
        <path d="M22 5C12.0589 5 4 13.0589 4 23C4 34.24 22 43 22 43C22 43 40 34.24 40 23C40 13.0589 31.9411 5 22 5Z" fill="url(#pinGradient)"/>
        <circle cx="22" cy="22" r="9" fill="rgba(255,255,255,0.2)"/>
      </g>
      <text x="22" y="27" text-anchor="middle" font-size="18" font-family="Arial, sans-serif" font-weight="700" fill="#fff">${labelText}</text>
    </svg>
  `;

  const encoded = encodeURIComponent(svg)
    .replace(/%0A/g, '')
    .replace(/%20/g, ' ');

  return {
    url: `data:image/svg+xml;charset=UTF-8,${encoded}`,
    scaledSize: new google.maps.Size(38, 44),
    anchor: new google.maps.Point(19, 44),
  };
}

function refreshMarkerIcons() {
  if (markers.length === 0) {
    return;
  }

  markers.forEach((entry) => {
    entry.marker.setIcon(null);
  });

  const entryMap = new Map();
  markers.forEach((entry) => {
    entryMap.set(entry.id, entry);
  });

  markerData.forEach((item, index) => {
    const entry = entryMap.get(item.id);
    if (!entry) {
      return;
    }
    const icon = getMarkerIcon(index);
    entry.marker.setIcon(icon || null);
  });
}

function renderMarkerList() {
  const listEl = document.getElementById('marker-list');
  if (!listEl) {
    return;
  }

  listEl.innerHTML = '';

  if (markerData.length === 0) {
    const emptyItem = document.createElement('li');
    emptyItem.className = 'marker-list__empty';
    emptyItem.textContent = '目前沒有儲存的地標。';
    listEl.appendChild(emptyItem);
    return;
  }

  markerData.forEach((item, index) => {
    if (!item) {
      return;
    }

    const { id, title, lat, lng } = item;
    const latText = typeof lat === 'number' ? lat.toFixed(6) : lat;
    const lngText = typeof lng === 'number' ? lng.toFixed(6) : lng;

    const listItem = document.createElement('li');
    listItem.className = 'marker-list__item';
    listItem.dataset.markerId = id;
    listItem.setAttribute('draggable', 'true');
    listItem.innerHTML = `
      <div class="marker-list__meta">
        <strong>${index + 1}. ${escapeHtml(title)}</strong>
        <span class="marker-list__coords">${latText}, ${lngText}</span>
      </div>
      <button type="button" class="marker-list__delete" data-marker-id="${escapeHtml(id)}">刪除</button>
    `;
    listEl.appendChild(listItem);
  });
}

function loadMarkers() {
  let stored = null;
  let items = null;

  try {
    stored = localStorage.getItem(STORAGE_KEY);
  } catch (error) {
    console.warn('讀取地標時發生錯誤：', error);
  }

  if (stored) {
    try {
      items = JSON.parse(stored);
    } catch (error) {
      console.warn('地標資料格式錯誤，無法解析：', error);
    }
  }

  if (!Array.isArray(items) || items.length === 0) {
    items = DEFAULT_MARKERS.map((marker) => ({
      id: typeof marker.id === 'string' ? marker.id : generateMarkerId(),
      title: marker.title || '未命名地標',
      lat: Number(marker.lat),
      lng: Number(marker.lng),
    }));
  }

  if (!Array.isArray(items) || items.length === 0) {
    markerData.length = 0;
    renderMarkerList();
    return;
  }

  markers.forEach((entry) => {
    if (entry.label) {
      entry.label.setMap(null);
    }
    entry.marker.setMap(null);
  });
  markers.length = 0;
  markerData.length = 0;

  const bounds = new google.maps.LatLngBounds();

  items.forEach((item) => {
    if (!item || !Number.isFinite(item.lat) || !Number.isFinite(item.lng)) {
      return;
    }

    const markerId = typeof item.id === 'string' ? item.id : generateMarkerId();
    const title = item.title || `地標 ${markerData.length + 1}`;
    const marker = addMarker({
      position: { lat: item.lat, lng: item.lng },
      title,
      pan: false,
      persist: false,
      id: markerId,
    });

    if (marker) {
      markerData.push({ id: markerId, title, lat: item.lat, lng: item.lng });
      bounds.extend(marker.getPosition());
    }
  });

  if (markerData.length > 0) {
    saveMarkers();
  }

  if (!bounds.isEmpty()) {
    map.fitBounds(bounds);
    if (map.getZoom() > 18) {
      map.setZoom(18);
    }
  }

  refreshMarkerIcons();
  renderMarkerList();
}

function createMarkerLabelClass() {
  return class MarkerLabel extends google.maps.OverlayView {
    constructor(marker, text) {
      super();
      this.marker = marker;
      this.text = text;
      this.div = null;
      this.positionListener = null;
      this.setMap(marker.getMap());
    }

    onAdd() {
      this.div = document.createElement('div');
      this.div.className = 'marker-label';
      this.div.textContent = this.text;

      const panes = this.getPanes();
      panes.overlayLayer.appendChild(this.div);

      this.positionListener = this.marker.addListener('position_changed', () => this.draw());
      this.draw();
    }

    draw() {
      if (!this.div) {
        return;
      }

      const projection = this.getProjection();
      const position = this.marker.getPosition();
      if (!projection || !position) {
        return;
      }

      const point = projection.fromLatLngToDivPixel(position);
      if (!point) {
        return;
      }

      const thresholdX = 36;
      const thresholdY = 28;
      let placeLeft = false;

      for (const entry of markers) {
        if (!entry || entry.marker === this.marker) {
          continue;
        }

        const otherPosition = entry.marker.getPosition();
        if (!otherPosition) {
          continue;
        }

        const otherPoint = projection.fromLatLngToDivPixel(otherPosition);
        if (!otherPoint) {
          continue;
        }

        const dx = otherPoint.x - point.x;
        const dy = Math.abs(otherPoint.y - point.y);

        if (dy <= thresholdY && dx > 0 && dx < thresholdX) {
          placeLeft = true;
          break;
        }
      }

      if (placeLeft) {
        const width = this.div.offsetWidth || 0;
        this.div.style.left = `${point.x - width - 14}px`;
      } else {
        this.div.style.left = `${point.x + 14}px`;
      }

      this.div.style.top = `${point.y - 20}px`;
    }

    onRemove() {
      if (this.positionListener) {
        google.maps.event.removeListener(this.positionListener);
        this.positionListener = null;
      }

      if (this.div) {
        this.div.remove();
        this.div = null;
      }
    }
  };
}

function addMarker({ position, title, pan = true, persist = true, id }) {
  let markerPosition;
  if (position instanceof google.maps.LatLng) {
    markerPosition = position;
  } else if (position && typeof position.lat === 'number' && typeof position.lng === 'number') {
    markerPosition = new google.maps.LatLng(position.lat, position.lng);
  } else {
    console.warn('無法建立地標：缺少有效座標。');
    return null;
  }

  const markerId = typeof id === 'string' ? id : generateMarkerId();
  const marker = new google.maps.Marker({
    map,
    position: markerPosition,
    title,
  });

  let label = null;
  if (MarkerLabelClass) {
    label = new MarkerLabelClass(marker, title);
  }

  markers.push({ id: markerId, marker, label });

  if (persist) {
    const coords = marker.getPosition();
    markerData.push({
      id: markerId,
      title,
      lat: coords.lat(),
      lng: coords.lng(),
    });
    saveMarkers();
    refreshMarkerIcons();
    renderMarkerList();
  }

  if (pan) {
    map.panTo(marker.getPosition());
  }

  return marker;
}

function removeMarker(markerId) {
  if (!markerId) {
    return;
  }

  const markerIndex = markers.findIndex((item) => item.id === markerId);
  if (markerIndex !== -1) {
    const { marker, label } = markers[markerIndex];
    if (label) {
      label.setMap(null);
    }
    marker.setMap(null);
    markers.splice(markerIndex, 1);
  }

  const dataIndex = markerData.findIndex((item) => item.id === markerId);
  if (dataIndex !== -1) {
    markerData.splice(dataIndex, 1);
    saveMarkers();
  }

  refreshMarkerIcons();
  renderMarkerList();
}

function reorderMarkerData(sourceId, targetId) {
  if (!sourceId || sourceId === targetId) {
    return;
  }

  const sourceIndex = markerData.findIndex((item) => item.id === sourceId);
  if (sourceIndex === -1) {
    return;
  }

  let insertIndex = markerData.length;
  if (targetId) {
    const targetIndex = markerData.findIndex((item) => item.id === targetId);
    if (targetIndex !== -1) {
      insertIndex = targetIndex;
    }
  }

  const [moved] = markerData.splice(sourceIndex, 1);
  if (sourceIndex < insertIndex) {
    insertIndex -= 1;
  }
  markerData.splice(insertIndex, 0, moved);
  saveMarkers();
  refreshMarkerIcons();
  renderMarkerList();
}

function hookUpForm() {
  const titleInput = document.getElementById('marker-title');
  const latInput = document.getElementById('marker-lat');
  const lngInput = document.getElementById('marker-lng');
  const addButton = document.getElementById('add-marker');

  addButton.addEventListener('click', () => {
    const title = titleInput.value.trim() || `地標 ${markerData.length + 1}`;
    const lat = Number(latInput.value);
    const lng = Number(lngInput.value);

    if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
      alert('請輸入正確的緯度與經度數值。');
      return;
    }

    addMarker({
      position: { lat, lng },
      title,
      pan: true,
      persist: true,
    });

    titleInput.value = '';
    latInput.value = '';
    lngInput.value = '';
  });

  map.addListener('click', (event) => {
    const lat = event.latLng.lat();
    const lng = event.latLng.lng();

    latInput.value = lat.toFixed(6);
    lngInput.value = lng.toFixed(6);
  });

  const listEl = document.getElementById('marker-list');
  listEl.addEventListener('click', (event) => {
    const button = event.target.closest('button[data-marker-id]');
    if (!button) {
      return;
    }

    const markerId = button.getAttribute('data-marker-id');
    removeMarker(markerId);
  });

  setupMarkerListDnD(listEl);
}

function setupMarkerListDnD(listEl) {
  if (!listEl) {
    return;
  }

  listEl.addEventListener('dragstart', (event) => {
    const item = event.target.closest('li[data-marker-id]');
    if (!item) {
      return;
    }

    dragState.sourceId = item.dataset.markerId;
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', dragState.sourceId);
    item.classList.add('marker-list__item--dragging');
  });

  listEl.addEventListener('dragover', (event) => {
    event.preventDefault();
    const item = event.target.closest('li[data-marker-id]');

    if (!item || item.dataset.markerId === dragState.sourceId) {
      clearHoverState(listEl);
      return;
    }

    if (dragState.hoverId !== item.dataset.markerId) {
      clearHoverState(listEl);
    }

    dragState.hoverId = item.dataset.markerId;
    item.classList.add('marker-list__item--dragover');
    event.dataTransfer.dropEffect = 'move';
  });

  listEl.addEventListener('dragleave', (event) => {
    const item = event.target.closest('li[data-marker-id]');
    if (item && item.dataset.markerId === dragState.hoverId) {
      item.classList.remove('marker-list__item--dragover');
      dragState.hoverId = null;
    }
  });

  listEl.addEventListener('drop', (event) => {
    event.preventDefault();
    const sourceId = dragState.sourceId || event.dataTransfer.getData('text/plain');
    const item = event.target.closest('li[data-marker-id]');
    const targetId = item ? item.dataset.markerId : null;

    cleanupDragState(listEl);
    reorderMarkerData(sourceId, targetId);
  });

  listEl.addEventListener('dragend', () => {
    cleanupDragState(listEl);
  });
}

function clearHoverState(listEl) {
  if (!dragState.hoverId) {
    return;
  }

  const hoverEl = listEl.querySelector(`li[data-marker-id="${dragState.hoverId}"]`);
  if (hoverEl) {
    hoverEl.classList.remove('marker-list__item--dragover');
  }
  dragState.hoverId = null;
}

function cleanupDragState(listEl) {
  clearHoverState(listEl);

  const draggingEl = listEl.querySelector('.marker-list__item--dragging');
  if (draggingEl) {
    draggingEl.classList.remove('marker-list__item--dragging');
  }

  dragState.sourceId = null;
}

function initMap() {
  const nchu = { lat: 24.123947, lng: 120.67481 };

  map = new google.maps.Map(document.getElementById('map'), {
    center: nchu,
    zoom: 16,
    styles: [
      {
        featureType: 'poi',
        stylers: [{ visibility: 'off' }],
      },
      {
        featureType: 'transit',
        stylers: [{ visibility: 'off' }],
      },
    ],
    mapTypeControl: false,
    streetViewControl: false,
  });

  MarkerLabelClass = createMarkerLabelClass();
  hookUpForm();
  loadMarkers();
}

window.initMap = initMap;
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCGAbOXotd2Y9pUJI8Wue4QLrrRcLvw_8Q&callback=initMap"></script>
</body>
</html>
